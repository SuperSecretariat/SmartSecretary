<div class="chat-wrapper">
  <div class="chat-container">
    <div id="chat-header" class="chat-header">
      Chat with Pubble AI
    </div>

    <div #chatBox id="chat-box" class="chat-box">
      <div
        *ngFor="let msg of messages; let i = index"
        [ngClass]="msg.sender === 'user' ? 'message-user' : 'message-bot'"
        class="message"
      >
        <div class="message-content">
          <strong>{{ msg.sender === 'user' ? 'You:' : 'Pubble:' }}</strong>
          <span [innerHTML]="formatMessageText(msg.displayed)"></span>
        </div>
        
        <!-- Sources toggle button for bot messages -->
        <div *ngIf="msg.sender === 'bot' && msg.sources && msg.sources.length > 0" class="sources-toggle">
          <button 
            class="sources-toggle-button"
            (click)="toggleSources(i)"
            [attr.aria-expanded]="msg.sourcesExpanded"
          >
            <span class="sources-icon">ðŸ“š</span>
            <span class="sources-title">Sources ({{ msg.sources.length }})</span>
            <span class="toggle-arrow" [class.expanded]="msg.sourcesExpanded">â–¼</span>
          </button>
          
          <!-- Collapsible sources section -->
          <div 
            class="message-sources" 
            [class.expanded]="msg.sourcesExpanded"
          >
            <div class="sources-list">
              <div 
                *ngFor="let source of msg.sources; let j = index" 
                class="source-item"
              >
                <span class="source-number">{{ j + 1 }}.</span>
                <span class="source-name">{{ getSourceFileName(source) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="spinner-container">
      <div class="spinner"></div>
    </div>

    <div class="input-area">
      <input
        type="text"
        id="user-input"
        [(ngModel)]="message"
        placeholder="Write a message..."
        [disabled]="isLoading"
        (keydown.enter)="sendMessage()"
      />

      <button
        class="mic-button"
        [class.recording]="isRecording"
        [class.transcribing]="isTranscribing"
        [disabled]="isLoading || isTranscribing"
        (click)="toggleRecording()"
        title="{{ isRecording ? 'Stop recording' : 'Start recording' }}"
      >
        <span class="mic-icon">ðŸ”´</span>
        <span *ngIf="isRecording" class="recording-indicator"></span>
      </button>

      <button
        class="send-button"
        [disabled]="isLoading || isRecording || isTranscribing"
        (click)="sendMessage()"
      >
        Send
      </button>
    </div>
  </div>
</div>